<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TCP概述 | 老杆的前端记录</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="Go big or go home">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.585d659a.js" as="script"><link rel="preload" href="/assets/js/2.5bf1c715.js" as="script"><link rel="preload" href="/assets/js/25.e878ae6c.js" as="script"><link rel="prefetch" href="/assets/js/10.3c4722f1.js"><link rel="prefetch" href="/assets/js/11.926d9a65.js"><link rel="prefetch" href="/assets/js/12.89662875.js"><link rel="prefetch" href="/assets/js/13.b24d0fd4.js"><link rel="prefetch" href="/assets/js/14.fe4261ec.js"><link rel="prefetch" href="/assets/js/15.d5d2b490.js"><link rel="prefetch" href="/assets/js/16.d7cb7df3.js"><link rel="prefetch" href="/assets/js/17.a8a539e4.js"><link rel="prefetch" href="/assets/js/18.9a7a379f.js"><link rel="prefetch" href="/assets/js/19.902e5d6c.js"><link rel="prefetch" href="/assets/js/20.89b4b03e.js"><link rel="prefetch" href="/assets/js/21.b9428d88.js"><link rel="prefetch" href="/assets/js/22.bca3e9c2.js"><link rel="prefetch" href="/assets/js/23.dd12f692.js"><link rel="prefetch" href="/assets/js/24.a1974514.js"><link rel="prefetch" href="/assets/js/26.efd1416d.js"><link rel="prefetch" href="/assets/js/27.867f73b1.js"><link rel="prefetch" href="/assets/js/28.fbfc66d6.js"><link rel="prefetch" href="/assets/js/29.279cac21.js"><link rel="prefetch" href="/assets/js/3.2cde5f11.js"><link rel="prefetch" href="/assets/js/30.4a27f7bc.js"><link rel="prefetch" href="/assets/js/31.11173338.js"><link rel="prefetch" href="/assets/js/32.c2786358.js"><link rel="prefetch" href="/assets/js/33.8f760173.js"><link rel="prefetch" href="/assets/js/34.f437c018.js"><link rel="prefetch" href="/assets/js/35.ca6d5641.js"><link rel="prefetch" href="/assets/js/36.e670371f.js"><link rel="prefetch" href="/assets/js/37.c5143da6.js"><link rel="prefetch" href="/assets/js/38.83226dcf.js"><link rel="prefetch" href="/assets/js/39.29c51311.js"><link rel="prefetch" href="/assets/js/4.90c5fe7f.js"><link rel="prefetch" href="/assets/js/40.9f439bf9.js"><link rel="prefetch" href="/assets/js/41.817698ff.js"><link rel="prefetch" href="/assets/js/42.7086e250.js"><link rel="prefetch" href="/assets/js/5.93058ddb.js"><link rel="prefetch" href="/assets/js/6.0e5f5053.js"><link rel="prefetch" href="/assets/js/7.e30bb482.js"><link rel="prefetch" href="/assets/js/8.5e1ee355.js"><link rel="prefetch" href="/assets/js/9.574fd584.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">老杆的前端记录</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link">
  求职笔记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端相关" class="dropdown-title"><span class="title">前端相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端相关" class="mobile-dropdown-title"><span class="title">前端相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontEnd/html/html-audition.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/css/css-audition.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/js/js-audition.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/vue/vue-audition.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/webpack/webpack-audition.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/browser/browser-audition.html" class="nav-link">
  Browser
</a></li></ul></div></div><div class="nav-item"><a href="/computerBase/" class="nav-link router-link-active">
  计算机基础
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link">
  求职笔记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端相关" class="dropdown-title"><span class="title">前端相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端相关" class="mobile-dropdown-title"><span class="title">前端相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontEnd/html/html-audition.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/css/css-audition.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/js/js-audition.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/vue/vue-audition.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/webpack/webpack-audition.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/browser/browser-audition.html" class="nav-link">
  Browser
</a></li></ul></div></div><div class="nav-item"><a href="/computerBase/" class="nav-link router-link-active">
  计算机基础
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>常见算法</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/computerBase/algorithm/sort.html" class="sidebar-link">十大排序算法</a></li><li><a href="/computerBase/algorithm/data-structure.html" class="sidebar-link">数据结构</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>力扣刷题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/computerBase/leetcode/bTree.html" class="sidebar-link">二叉树</a></li><li><a href="/computerBase/leetcode/house-robber.html" class="sidebar-link">打家劫舍</a></li><li><a href="/computerBase/leetcode/path-sum.html" class="sidebar-link">路径总和</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>计算机网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/computerBase/net/brief.html" class="sidebar-link">概述</a></li><li><a href="/computerBase/net/data-link-layer.html" class="sidebar-link">数据链路层</a></li><li><a href="/computerBase/net/network-layer.html" class="sidebar-link">网络层</a></li><li><a href="/computerBase/net/TCP.html" aria-current="page" class="active sidebar-link">TCP概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computerBase/net/TCP.html#运输层概念" class="sidebar-link">运输层概念</a></li><li class="sidebar-sub-header"><a href="/computerBase/net/TCP.html#tcp特点" class="sidebar-link">TCP特点</a></li><li class="sidebar-sub-header"><a href="/computerBase/net/TCP.html#可靠传输的工作原理" class="sidebar-link">可靠传输的工作原理</a></li><li class="sidebar-sub-header"><a href="/computerBase/net/TCP.html#tcp报文段的首部格式" class="sidebar-link">TCP报文段的首部格式</a></li><li class="sidebar-sub-header"><a href="/computerBase/net/TCP.html#tcp可靠传输的实现" class="sidebar-link">TCP可靠传输的实现</a></li><li class="sidebar-sub-header"><a href="/computerBase/net/TCP.html#tcp的流量控制" class="sidebar-link">TCP的流量控制</a></li><li class="sidebar-sub-header"><a href="/computerBase/net/TCP.html#tcp的拥塞控制" class="sidebar-link">TCP的拥塞控制</a></li><li class="sidebar-sub-header"><a href="/computerBase/net/TCP.html#tcp的连接" class="sidebar-link">TCP的连接</a></li></ul></li><li><a href="/computerBase/net/DNS.html" class="sidebar-link">域名系统DNS</a></li><li><a href="/computerBase/net/Http.html" class="sidebar-link">HTTP</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tcp概述"><a href="#tcp概述" class="header-anchor">#</a> TCP概述</h1> <h2 id="运输层概念"><a href="#运输层概念" class="header-anchor">#</a> 运输层概念</h2> <p>网络层为主机之间提供逻辑通信，而运输层为应用进程之间提供端到端的逻辑通信。</p> <p>软件端口是应用层的各种协议进程与运输实体进行层间交互的一种地址。TCP/IP的运输层用一个16位的端口号来标志一个端口。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>运输层端口号分为两大类：</p> <p>服务端端口号：包含熟知端口号、登记端口号</p> <p>客户端端口号：短暂端口号</p></div> <h2 id="tcp特点"><a href="#tcp特点" class="header-anchor">#</a> TCP特点</h2> <ul><li>面向连接的运输层协议</li> <li>每一条TCP连接只能有两个端点，<strong>点对点的</strong></li> <li>TCP提供<strong>可靠交付</strong>的服务</li> <li>TCP提供全双工通信，发送端和接收端都设有缓存</li> <li>面向<strong>字节流</strong>。TCP中的流指的是流入到进程或者从进程流出的字节序列</li></ul> <p>TCP的报文长度是由对方给出的窗口值和当前网络的拥塞程度决定的</p> <p>TCP连接的端点是<strong>套接字</strong>接口，端口号拼接到IP地址即构成了套接字</p> <h2 id="可靠传输的工作原理"><a href="#可靠传输的工作原理" class="header-anchor">#</a> 可靠传输的工作原理</h2> <h3 id="停止等待协议"><a href="#停止等待协议" class="header-anchor">#</a> 停止等待协议</h3> <ul><li>无差错情况：A发送分组后暂停发送，等待接收方B的确认，B收到后向A发送确认</li> <li>出现差错：B接收到了差错，就丢弃A传送的分组且不发送任何信息，A过一段时间没有收到确认，就会<strong>超时重传</strong></li> <li>确认丢失和确认迟到：B发送的确认在途中丢失了，A发生了超时重传，那么B就会收到两份一样的，B应该丢弃重复的，并重新向A发送确认</li></ul> <p>可靠传输协议称为<strong>自动重传请求ARQ协议</strong>。意思是重传的请求<strong>自动进行</strong>，接收方不需要请求发送方重传某个出错的分组，超时了自动重传</p> <p>这种停止等待协议，信道的利用率太低</p> <h3 id="连续arq协议"><a href="#连续arq协议" class="header-anchor">#</a> 连续ARQ协议</h3> <p>发送方维持着一个窗口，窗口内的分组可以连续的发送出去而无需等待对方的确认，当收到一个确认之后，窗口就向前移动</p> <p>接收方采用<strong>累计确认</strong>的方式，不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，表示到这个分组为止的所有分组都已正确收到了</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>优点：确认丢失也不必重传</p> <p>缺点：无法向发送方反映接收方已经正确收到的所有分组的信息</p></div> <h2 id="tcp报文段的首部格式"><a href="#tcp报文段的首部格式" class="header-anchor">#</a> TCP报文段的首部格式</h2> <ul><li><p>报文首部前20个字节是固定。首部最小长度是20个字节，最大长度60个字节</p> <ul><li><p>源端口和目的端口，各占2个字节</p></li> <li><p>序号，4个字节，指的是本报文段所发送的数组的第一个字节的序号</p></li> <li><p>确认号，4个字节，指期望收到对方下一个报文段的第一个数据字节的序号，<strong>若确认号为N，表示到序号N-1为止的数据都已收到</strong>。B收到A序号300，长度100的数据，B给A发送确认号就应该为401，期望下次A从401开始发送</p></li> <li><p>数据长度，4位，即首部长度，</p></li> <li><p>控制位，占6位，表明这个报文段的意思</p> <ul><li>紧急</li> <li>确认ACK，当ACK为1的时候确认号字段才有效，TCP连接后的所有传送报文段都必须把ACK置为1</li> <li>推送</li> <li>复位</li> <li>同步SYN，<strong>SYN=1表示这是一个连接请求或者连接接收的报文</strong>；在连接建立时用来同步序号。当SYN=1时而ACK等于时表明这是个连接请求报文。当对方同意连接，则响应报文中SYN=1和ACK=1。</li> <li>终止FIN，<strong>用来释放一个连接</strong>。当FIN=1时，表明<strong>此报文段的发送方</strong>数据已经发送完毕，并要求释放运输链接</li></ul></li> <li><p>窗口，指的时发送本报文段的一方的接收窗口，不是自己的发送窗口，窗口值告诉对方，<strong>从本报文段首部中的确认号算起，对方最多给自己发送的数据长度</strong>。发送一个窗口值1000加确认号701，表示我最多能接收你从701开始的1000个字段，即可以理解为<strong>接收窗口</strong></p></li> <li><p>校验和，2字节，对报文首部和数据进行校验</p></li> <li><p>紧急指针</p></li> <li><p>选项，可变，最长40个字节</p></li></ul></li></ul> <h2 id="tcp可靠传输的实现"><a href="#tcp可靠传输的实现" class="header-anchor">#</a> TCP可靠传输的实现</h2> <h3 id="滑动窗口"><a href="#滑动窗口" class="header-anchor">#</a> 滑动窗口</h3> <p>滑动窗口时以字节为单位的，发送方A的发送窗口，发送窗口里面的序号表示允许发送的序号。</p> <p>发送窗口：在没有收到接收方的确认之前，窗口内的数据都可以发送出去，但不能超过接收方的接受窗口大小</p> <p>接收方对按序收到的数据中的最高序号给出确认，例如序号为31的数据丢失了或者滞留，32、33的数据收到了，但接收方还是给出确认号为31的报文段。</p> <h3 id="超时重传时间的选择"><a href="#超时重传时间的选择" class="header-anchor">#</a> 超时重传时间的选择</h3> <p>TCP采取了一种自适应算法，记录报文段发出的时间以及收到相应的确认的时间，两个时间之差就是<strong>报文段的往返时间RTT</strong>，TCP计算RTT的一个<strong>加权平均往返时间RTTs</strong>，<strong>超时重传时间RTO</strong>略大于上面得出的RTTs</p> <details class="custom-block details"><summary>Q&amp;A</summary> <p>Q：如何判定此确认报文段时对先发送的报文段的确认，还是对后来重传的报文段的确认？</p> <p>A：如果是前者，则RTTs和RTO都偏大；如果是后者，则RTTs和RTO都偏小，重传较为频繁；所以TCP对重传的报文段进行了区分：<strong>报文段每重传一次，就把超时重传时间RTO增大一些</strong></p></details> <h3 id="选择确认sack"><a href="#选择确认sack" class="header-anchor">#</a> 选择确认SACK</h3> <p>目的：只传送缺少的数据而不重传已经正确到达接收方的数据</p> <p>假设接收方窗口里面序号1~1000接收到了，1001~1500丢失，1501~3000接收到了，3001~3500丢失，3501~4500接收到；因为接收方对按序到达的最后一个分组发送确认，所以确认号是1001，表示希望发送方下一次发送的报文段序列号是1001，从1001开始重传；现如今可以在<strong>首部选项</strong>里加上SACK选项，需要两个字节指明是SACK选项和指明这个选项要多少个字节，<strong>记录丢失报文的左边界和右边界</strong>，记录一个边界需要4个字节（序号是4个字节），一个丢失的报文段有2个边界，所以最多记录4个字节块，8X4 + 2 = 34，因为可选选项最大40个字节。</p> <h2 id="tcp的流量控制"><a href="#tcp的流量控制" class="header-anchor">#</a> TCP的流量控制</h2> <p>流量控制：<strong>让发送方的发送速率不要太快，要让接收方来得及接收</strong>。利用滑动窗口机制可以很方便地在TCP连接上实现对发送方的流量控制</p> <p>接收方B告诉发送方A接收窗口<strong>rwnd</strong>等于多少，<strong>发送方的发送窗口不能超过接收方给出的接收窗口的大小</strong></p> <p>需要控制发送方的接收窗口不能太小，不能一有空间就告诉发送方仅有的大小；发送方一次也不能发送很小的报文段</p> <h2 id="tcp的拥塞控制"><a href="#tcp的拥塞控制" class="header-anchor">#</a> TCP的拥塞控制</h2> <p>拥塞：对网络中某一资源的需求超过了该资源所能提供的可用部分时，网络的性能就要变坏，这种情况叫做拥塞</p> <p>拥塞控制：防止过多的数据注入到网络中，这样可以让网络中的路由器或链路不致过载。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>拥塞控制是全局性的问题，涉及到网络中所有主机、所有路由器，考虑网路的吞吐量；</p> <p>流量控制是点对点通信量的控制，是端到端的问题，考虑发送方的速率接收方的速率</p></div> <p><strong>理想情况</strong>下，随着网络输入负载的增加，网络的吞吐量也会在饱和前呈<strong>线性增长</strong>；而<strong>实际情况</strong>下，在网络吞吐量未达到饱和值之前，网络吞吐量明显小于理想的吞吐量的时候，网络就进入了<strong>轻度拥塞</strong>的状态；当吞吐量随负载输入的增大而下降时，网络就进入了<strong>拥塞状态</strong></p> <h3 id="tcp拥塞控制的方法"><a href="#tcp拥塞控制的方法" class="header-anchor">#</a> TCP拥塞控制的方法</h3> <h4 id="慢开始"><a href="#慢开始" class="header-anchor">#</a> 慢开始</h4> <p>发送方维持一个拥塞窗口<strong>cwnd</strong>的状态变量，大小取决于网络的拥塞程度，动态变化，<strong>发送方让发送窗口等于拥塞窗口</strong></p> <p>只要网络不出现拥塞，拥塞窗口就可以扩大一些；如果出现拥塞了，拥塞窗口就缩小一些。<strong>判断网络拥塞的依据就是出现了超时</strong></p> <p>拥塞窗口的计算：由小到大逐渐增大发送窗口，也就是由小到大逐渐增大拥塞窗口，首先规定初始的初始拥塞窗口，每收到一个对新的报文段的确认后，可以把拥塞窗口增加最多一个<strong>SMSS</strong>（发送方的最大报文字段，即报文中的最大长度）的数值；</p> <p>第一轮发送一个报文，收到确认后，发送窗口翻倍，发送两个报文，均收到确认，窗口再翻倍，只要收到一个报文段的确认，窗口就加1</p> <p>一个传播轮次所经历的时间就是<strong>RTT</strong>，RTT不是固定不变的，一次轮次RTT指的是将发送窗口的数据都给发送完且均收到确认的时间，这是理想化的，因为实际中，每收到一个确认就能立刻发送新的报文。</p> <p>慢开始的慢不是指增长速率慢，而是指TCP在开始发送报文时初始cwnd比较小，和刚开始把cwnd设置的很大、很多报文段可以注入网络相比慢。</p> <h4 id="拥塞避免"><a href="#拥塞避免" class="header-anchor">#</a> 拥塞避免</h4> <p>为了防止当拥塞窗口，即发送窗口增大到过大而引起网络拥塞，要给拥塞窗口设置一个<strong>阈值</strong>，当<code>cwnd</code>小于这个阈值，采用慢开始算法；当<code>cwnd</code>超过这个阈值，采取用<strong>拥塞避免</strong>算法</p> <p>拥塞避免算法：每经过一个往返时间RTT就把发送方的拥塞窗口cwnd加1，而不是像慢开始一样加倍增长，比慢开始算法增长缓慢了许多</p> <p>一个轮次并不表示一条报文，可以发送许多报文</p> <p>先执行慢开始算法，当达到慢开始门限时，采用拥塞避免算法，缓慢增长，网络拥塞出现报文段丢失时，门限值降为原来的一半，窗口变为1重新开始慢开始算法。</p> <h4 id="快重传"><a href="#快重传" class="header-anchor">#</a> 快重传</h4> <p>快重传可以<strong>让发送方尽早知道发生了个别报文段的丢失</strong></p> <p>假定接收方都正确收到了报文M1、M2，但是丢失了M3收到了M4，本来接收方可以什么都不做，等待发送方超时重传即可，但快重传算法要求接收方<strong>必须立即发送对M2的确认</strong>，当发送方<strong>连续收到3个对M2的重复确认后</strong>，就知道接收方没有收到M3，就会<strong>立刻进行重传</strong></p> <h4 id="快恢复"><a href="#快恢复" class="header-anchor">#</a> 快恢复</h4> <p>当发送方知道只是个别报文的丢失，就不会以<strong>慢开始</strong>算法重新开始，而是以<strong>快恢复算法</strong>开始，此时，将慢开始门限<strong>减半</strong>，且拥塞窗口设置成<strong>阈值</strong>，直接从<strong>拥塞避免算法</strong>开始执行</p> <p>将拥塞控制的发送窗口（即拥塞窗口），和接收方对发送方的流量控制（即告诉发送方最大不能超过多少）结合起来，显然，发送方的窗口的上限应当取为接收方窗口rwnd和拥塞窗口cwnd中的较小值。</p> <p><strong>拥塞窗口和接收方窗口一起控制了发送方的发送速率</strong></p> <h3 id="主动队列管理aqm"><a href="#主动队列管理aqm" class="header-anchor">#</a> 主动队列管理AQM</h3> <p>网络层的策略对TCP拥塞控制影响最大的就是<strong>路由器的分组丢弃策略</strong>，最简单的情况下，路由器的队列是按照<strong>先进先出</strong>的规则处理的，当路由器的队列长度已经达到最大值，不得不丢掉后面到达的分组。AQM指的是应当到达某个警惕的数值时就主动丢弃分组，提醒发送方的发送速率，可能使网络的拥塞程度减轻。</p> <p>AQM的实现方法：<strong>RED</strong></p> <p>RED：随机早期检测，当平均队列长度小于最小门限，新到达的分组放入队列中进行排队；当大于最大门限，把新到达的分组丢弃；当处于中间，以某一丢弃概率p丢弃新到达的分组</p> <h2 id="tcp的连接"><a href="#tcp的连接" class="header-anchor">#</a> TCP的连接</h2> <p>运输连接有三个阶段：连接建立、数据传送、连接释放</p> <h3 id="三次握手"><a href="#三次握手" class="header-anchor">#</a> 三次握手</h3> <p>1、状态：CLOSED，客户端A主动打开连接，服务器B被动打开连接</p> <p>2、客户端创建传输控制块TCB，向B发出SYN=1，同时选择一个序列号seq=x。SYN=1的数据报不能携带数据，但要消耗一个序号，这时B能确定A的发能力</p> <p>3、B收到请求连接报文段后，要向A发送确认。SYN=1,ACK=1，确认号ack是x+1，同时选择自己的一个序列号y，不能携带数据，也要消耗一个序号，A收到后能确认B的收发能力</p> <p>4、A收到B的确认后，还要向B发送确认。ACK=1，ack=y+1，自己的序列号是x+1，这个报文段可以发送数据了，这是B能知道A的收发能力。</p> <details class="custom-block details"><summary>Q&amp;A</summary> <p>Q：为什么两次握手不行？</p> <p>A：有之前的异常连接请求滞留在网络中，当再发给B时，B会以为A再发了一次新的连接请求，于是向A发送了确认，又建立了连接，但此时A又不想给B发数据，所以不会确认B的连接请求，这样B的资源就白白浪费了</p></details> <h4 id="四次挥手"><a href="#四次挥手" class="header-anchor">#</a> 四次挥手</h4> <p>1、A主动发出连接释放报文，停止发送数据，FIN=1，seq=u，等于前面已传送的数据的最后一个字节加一，A进入FIN-WAIT-1状态，等待B的确认，FIN报文段即使不携带数据，也要消耗掉一个序号</p> <p>2、B收到A的释放请求后，要发送确认，发出ACK=1，ack确认号等于u+1（希望收到下次A发送过来的序列号是u+1），选择自己序列号为v，等于B前面已传送过的数据的最后一个字节的序号加一，B进入CLOSE-WAIT状态，这时，<strong>A向B这个方向的连接就释放了，TCP处于半关闭状态</strong></p> <p>3、A收到B的确认后，进入FIN-WAIT2状态，等到B发送它的请求释放报文</p> <p>4、若B已经没有数据要发给A，则发送FIN=1，序列号为w，ACK=1，重复发送确认号为u+1（希望收到下次A发送过来的序列号是u+1，因为A已经不能发送数据，这个确认号和上一次必须一致），B进入LAST-ACK最后确认状态</p> <p>5、A收到B的请求释放连接报文后，也要做出确认。确认报文中ACK=1，ack=w+1，而自己的序列号是u+1，然后进入<strong>TIME-WAIT（时间等待）状态</strong>，现在TCP还没有被释放掉，必须经过<strong>时间等待计时器设置的时间2MSL</strong>后，A才进入CLOSED状态；<strong>B结束TCP连接的时间要比A早</strong></p> <details class="custom-block details"><summary>Q&amp;A</summary> <p>Q：为什么A在最后一次挥手发出确认报文后还要等待2MSL才进入CLOSED状态？</p> <p>A：为了保证A传的确认报文能够到达B，这个ACK报可能丢失，如果丢失，B收不到确认，就要重传，A就能在2MSL时间内收到重传这个FIN+ACK报文段。接着A再重传一次确认，重新启动时间等待计时器。如果A立刻释放连接，那么当报文丢失的时候就收不到B的重传报文；A在发送完最后一个ACK报文后，再经过2MSL，就能使本次连接内所有的报文段都从网络中消失，这样就可以使下一个新的连接中不会出现这种旧的连接请求报文段。</p></details> <h3 id="和udp的区别"><a href="#和udp的区别" class="header-anchor">#</a> 和UDP的区别</h3> <p>相同点：都是运输层的协议，提供应用进程之间的逻辑通信，端到端，都有<strong>复用</strong>和<strong>分用</strong>的功能</p> <p>复用：指的是应用层所有应用进程都可以通过运输层在传送给到IP层</p> <p>分用：指的是运输层从IP层收到发送给各应用进程的数据后，必须分别交付指明的各应用进程</p> <h4 id="udp的特点"><a href="#udp的特点" class="header-anchor">#</a> UDP的特点</h4> <ul><li><strong>无连接</strong>，减少了开销和发送数据之前的时延，端口处没有套接字</li> <li>尽<strong>最大努力交付</strong>。不需要为止复杂的连接状态</li> <li>首部只有8个字节</li> <li>面向<strong>报文段</strong>，对于向上交付过来的IP数据报，去除首部后的报文原封不动的转发</li> <li><strong>没有拥塞控制</strong>，比较适合于实时的应用</li> <li>支持<strong>一对一、一对多、多对一、多对多</strong>的交互通信</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/computerBase/net/network-layer.html" class="prev">
        网络层
      </a></span> <span class="next"><a href="/computerBase/net/DNS.html">
        域名系统DNS
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.585d659a.js" defer></script><script src="/assets/js/2.5bf1c715.js" defer></script><script src="/assets/js/25.e878ae6c.js" defer></script>
  </body>
</html>
